name: Deploy to Baota Panel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install pnpm
      run: |
        npm install -g pnpm

    - name: Install dependencies
      run: |
        pnpm install --production

    - name: Build project
      run: |
        pnpm build

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /www/wwwroot/chadao
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -d ".next" ]; then
            BACKUP_DIR="/backup/chadao_$(date +%Y%m%d_%H%M%S)"
            mkdir -p $BACKUP_DIR
            cp -r .next $BACKUP_DIR/
            echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
          fi
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          git fetch origin
          git reset --hard origin/main
          git clean -fd
          
          # å®‰è£…ä¾èµ–
          pnpm install --production
          
          # æ„å»ºé¡¹ç›®
          pnpm build
          
          # è®¾ç½®æƒé™
          chown -R www:www .
          chmod -R 755 .
          
          # é‡å¯PM2
          if command -v pm2 &> /dev/null; then
            if pm2 list | grep -q "chadao"; then
              pm2 restart chadao
            else
              pm2 start ecosystem.config.js
            fi
            pm2 save
          fi
          
          # é‡è½½Nginx
          if command -v nginx &> /dev/null; then
            nginx -t && nginx -s reload
          fi
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"

    - name: Notify deployment
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: https://your-domain.com"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi
